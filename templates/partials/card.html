{% load static %}
{% load dict_extras %}
<div class="game-card" data-game="{{ game.id }}">
        {% if game.cover_url %}
             <img src="{{ game.cover_url }}" alt="{{ game.name }}" class="game-image">
        {% else %}
             <img src="/static/img/no-cover.png" alt="No-cover" class="game-image">   
        {% endif %}       
        <div>
            <h3>
                {{ game.name }} 
                {% if game.overall_rating_image %}
                    <img src="{{ game.overall_rating_image }}" alt="avg rating image" class="rating-image" id="game-{{ game.id }}-rating_image">
                {% endif %}
            </h3>
        </div>
            
            <p>{{ game.released }}</p>
            <a href="{% url 'wishlist_toggle' game.id %}">
                {% if game.id in wishlist_games %}
                    <img src="{% static 'img/icons/w_add.svg' %}" alt="added to wishlist" class="wishlist-icon-add">
                {% else %}
                    <img src="{% static 'img/icons/w_add.svg' %}" alt="remove from wishlist" class="wishlist-icon-remove">
                {% endif %}
            </a>
        {% if game.id in library_games %}
        <div class="library-wrapper">
            <a href="{% url 'library_toggle' game.id %}">
                <img src="{% static 'img/icons/library_add.svg' %}" title="library_add" class="library-icon">
            </a>
            <img src="{% static 'img/icons/downarrow.svg' %}" title="dropdown" class="dropdown-toggle">
            <div class="dropdown-menu">
                {% for status in statuses %}
                     <a href="{% url 'update_status' game.id status.id %}" class="status-item">
                        
                        <div class="status-main">
                            <img src="{{ status.image.url }}" class="dropdown-icon">
                            <span class="status-name">{{ status.name }}</span>
                        </div>
                        <span class="status-desc">{{ status.description }}</span>
                     </a>
                {% endfor %}
                <div class="status-remove">
                   <a href="{% url 'library_toggle' game.id %}">Remove from Library </a>
                </div>
                
            </div>

        </div>  
        {% else %}
        <a href="{% url 'library_toggle' game.id %}">
            <img src="{% static 'img/icons/library_remove.svg' %}" class="library-icon"></a>
        {% endif %}  

        <div class="overall-rating">
            <strong id="game-{{ game.id }}-label ">{{ game.overall_label }}</strong>
            <span id="game-{{ game.id }}-avg">{{ game.overall_average }}</span>
        </div>
        <div class="category-avg-check">
            {% for category in categories %}
                {{ category.name }}
                (<span id="avg-{{ game.id }}-{{ category.key }}">{{ game|category_average_filter:category.key }}</span>)
            {% endfor %}
        </div>
        <button class="overall-open" data-game= "{{ game.id }}"> Rate</button>
        <div class="rating-bar" id="overall-bar- {{ game.id }}">
            {% if game.overall_breakdown %}
                {% for r in game.overall_breakdown %}
                    {% if r.id %}
                        <div class="segment" style="width: {{ r.percentage }}%; background: {{ r.color }}" >
                        {% if r.image %}
                        <img src="{{ r.image }}" alt="{{ r.name }}" class="rating-image">
                        {% endif %}
                    </div>
                    {% else %}
                        <div class="segment" style="width: 100%; background: grey">
                            <span>no reviews</span>
                        </div>
                    {% endif %}  
                {% endfor %}
            {% else %}
                 <div class="segment" style="width: 100%; background: grey">
                        <span>no reviews</span>
                 </div>         
            {% endif %}
        </div>

        <div class="overall-model" id="modal-{{ game.id }}">
            <div class="model-box">
                <button class="close">X</button>
                <h4>overall rating</h4>
                <div class="rating-grid">
                    {% for rate in rating_types %}
                       <button  type="button" class="rate-btn overall-btn 
                                {% if overall_rating|get_item:game.id == rate.id %}active{% endif %}"
                                data-game="{{ game.id }}"
                                data-rating="{{ rate.id }}">
                                <img src="{{ rate.image.url }}" alt="{{ rate.name }}" width="24">
                                {{ rate.name }}
                       </button>
                    {% endfor %}
                </div>
                <hr>
                <div class="category-model" id="modal-{{ game.id }}">
                    {% for category in categories %}
                      <div class="category-block">
                        <h4>{{ category.name }}</h4>
                        {% for rate in rating_types %}
                        <button  type="button" class="rate-btn category-btn
                                  {% if category_rating|get_item:game.id|get_item:category.id == rate.id %}active{% endif %}"
                                  data-game="{{ game.id }}"
                                  data-rating="{{ rate.id }}"
                                  data-category="{{ category.id }}">
                                
                                <img src="{{ rate.image.url }}" alt="{{ rate.category_rating_name }}" width="24">
                        </button>
                           
                        {% endfor %}
                      </div>
                    {% endfor %}
                </div>
            </div>
        </div>

        
</div>

<script>
document.addEventListener("click", function (e) {

    // Close all dropdowns on outside click
    document.querySelectorAll(".dropdown-menu").forEach(menu => {
        if (!menu.contains(e.target)) {
            menu.classList.remove("show");
        }
    });

    // Toggle dropdown ONLY on arrow click
    if (e.target.classList.contains("dropdown-toggle")) {
        e.stopPropagation(); 
        const wrapper = e.target.closest(".library-wrapper");
        wrapper.querySelector(".dropdown-menu").classList.toggle("show");
    }
});
//  rating
document.addEventListener("DOMContentLoaded", function() {
    // Open modal
    function openModal(modal) {
        modal.classList.add("active");
    }

    // Close modal
    function closeModal(modal) {
        modal.classList.remove("active");
    }

    // Open modal on "Rate" button click
    document.querySelectorAll(".overall-open").forEach(btn => {
        btn.addEventListener("click", function(e) {
            e.stopPropagation(); // prevent document click from closing modal
            const gameId = this.dataset.game;
            const modal = document.getElementById(`modal-${gameId}`);
            // close currently opened model before opening another model
            document.querySelectorAll(".overall-model.active").forEach(activeModal => {
                if (activeModal != modal){
                    closeModal(activeModal);
                }
            });
            if(modal) openModal(modal);
        });
    });

    // Close modal on "X" button click
    document.querySelectorAll(".overall-model .close").forEach(btn => {
        btn.addEventListener("click", function(e) {
            e.stopPropagation();
            const modal = this.closest(".overall-model");
            closeModal(modal);
        });
    });

    // Close modal if clicking outside
    document.addEventListener("click", function(e) {
        document.querySelectorAll(".overall-model.active").forEach(modal => {
            // If click is outside the modal and outside the "Rate" button
            if(!modal.contains(e.target) && !e.target.classList.contains("overall-open")) {
                closeModal(modal);
            }
        });
    });
    // save and toggle overall rating via fetch
    document.querySelectorAll(".overall-btn").forEach(btn => {
    btn.addEventListener("click", function(e) {
        e.preventDefault();
        e.stopPropagation();
        console.log("hi")

        if (this.dataset.loading === "true") return;

        const gameId = this.dataset.game;
        const ratingId = this.dataset.rating;
        
        this.dataset.loading = "true";

        fetch("{% url 'save_overall_rating' %}", {
            method: "POST",
            headers: {
                "content-type": "application/x-www-form-urlencoded",
                "x-CSRFToken": "{{ csrf_token }}"
            },
            body: new URLSearchParams({
                "game_id": gameId,
                "rating_id": ratingId
            })
        })
        .then(res => res.json())
        .then(data => {
            if (data.success) {
                // 1. Manage Active States
                const modalButtons = document.querySelectorAll(`#modal-${gameId} .overall-btn`);
                modalButtons.forEach(b => b.classList.remove("active"));

                // Only re-add active if we didn't just delete it
                if (data.action === "saved") {
                    btn.classList.add("active");
                }

                const avgEle = document.querySelector(`#game-${gameId}-avg`);
                const labelEle = document.querySelector(`#game-${gameId}-label`);
                const ratingAvgImg = document.querySelector(`#game-${gameId}-rating_image`);

                if(avgEle) avgEle.textContent = data.avg;                
                if(labelEle) labelEle.textContent = data.label;
                if(ratingAvgImg) {
                    if (data.rating_image) {
                        ratingAvgImg.src = data.rating_image;
                        ratingAvgImg.style.display = "inline-block";
                    } else {
                        ratingAvgImg.style.display = "none";
                    }
                }
            }
        })
        .catch(err => console.error("Error:", err))
        .finally(() => {
            delete this.dataset.loading;
        });
    });
});
    // save category-rating via fetch api
    document.querySelectorAll(".category-btn").forEach(btn => {
        btn.addEventListener("click", function(e) {
            e.preventDefault();
            e.stopPropagation();

            if (this.dataset.loading === "true") return;

            const gameId = this.dataset.game;
            const ratingId = this.dataset.rating;
            const categoryId = this.dataset.category;
            
            this.dataset.loading = "true";

            fetch("{% url 'save_category_rating' %}", {
                method: "POST",
                headers: {
                    "content-type": "application/x-www-form-urlencoded",
                    "x-CSRFToken": "{{ csrf_token }}"
                },
                body: new URLSearchParams({
                    "game_id": gameId,
                    "rating_id": ratingId,
                    "category_id": categoryId
                })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // 2. Manage Active States (ONLY for buttons within THIS category block)
                    const categoryBlock = this.closest(".category-block");
                    const categoryButtons = categoryBlock.querySelectorAll(".category-btn");
                    
                    categoryButtons.forEach(b => b.classList.remove("active"));

                    if (data.action === "saved") {
                        btn.classList.add("active");
                    }

                    const catAvgEle = document.getElementById(`avg-${gameId}-${data.category_key}`);
                    if (catAvgEle) {
                        catAvgEle.textContent = data.category_avg;
                    } 
                }    
            })
            .catch(err => console.error("Error:", err))
            .finally(() => {
                delete this.dataset.loading;
            });
        });
    });
});

</script>